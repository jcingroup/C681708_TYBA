@using OutWeb.Models.FrontEnd.TrainModels.TrainApplyModels
@model TrainApplyViewModel
@Scripts.Render("~/Scripts/jquery-1.10.2.min.js")

@{
    ViewBag.Title = "研討會";
    ViewBag.BodyClass = "Train";
    ViewBag.Subnav = "Apply";
    ViewBag.Breadcrumb = "線上報名編輯"; @* 最後層的麵包屑 *@
string alert = string.Format(@"<p class=""my-24"">因名額有限，每一用戶編號，僅限 {0} 位報名。已超過報名截止日，如有需求請聯絡{1}，電話：03-5910085</p>", Model.TrainInfo.SingleEnrollmentRestrictions, Model.TrainInfo.ContactPerson);
string stopRegistering = Model.TrainInfo.IsStopRegistering ? "" : @"<span class=""label-warning ti-na"">報名截止</span>";
string disableSubmit = Model.TrainInfo.IsStopRegistering ? "" : "disabled";
}

@* 中間層的麵包屑 *@
@section breadcrumb {
    <li><a href="~/Train">研討會</a></li>
    <li><a href="~/Train/Content">@Model.TrainInfo.ActivityName</a></li>
}
<div class="wrap zoom">
    @Html.Partial("../Train/sidebar")

    <div id="content" class="text-left">

        <header class="sub-title">
            <h3 class="underline mt-0"><span class="text-black mr-16">您欲參加的活動是</span> @Html.Raw(stopRegistering) @Model.TrainInfo.ActivityName</h3>
            <small class="date font-sm">最後修改時間: @Model.Apply.UpdateTime</small>
        </header>

        @using (Html.BeginForm("TrainApply", "User", FormMethod.Post, new { id = "frmFrontUserTrainApply", @class = "bg-muted form-signup" }))
        {

            <input type="hidden" name="TrainInfo.ID" value="@Model.TrainInfo.ID" />
            <input type="hidden" name="Apply.ID" value="@Model.Apply.ID" />

            <fieldset class="mb-24">
                <legend class="font-xl">
                    報名資料
                    <button class="btn danger pull-right ti-trash" type="button" id="delApply">刪除報名</button>
                </legend>

                <dl class="field mb-24">
                    <dt class="col-sm-2"><sup title="必填">*</sup> <label for="Apply.UserNo">用戶編號</label></dt>
                    <dd class="col-sm-10">
                        <input type="text" class="form-element" name="Apply.UserNo" id="Apply.UserNo" disabled required value="@Model.Apply.UserNo" placeholder="請輸入用戶編號">
                        <small class="text-danger">* 無用戶編號者請來電詢問 03-5910085 僅限生產性質產業用戶報名</small>
                    </dd>
                </dl>
                <section class="col-md-6 pl-0">
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><sup title="必填">*</sup> <label for="Apply.CompanyName">公司名稱</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="text" class="form-element" name="Apply.CompanyName" id="Apply.CompanyName" required value="@Model.Apply.CompanyName" placeholder="請輸入公司名稱">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><sup title="必填">*</sup> <label for="Apply.ContactPerson">姓名(聯絡人)</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="text" class="form-element" name="Apply.ContactPerson" id="Apply.ContactPerson" required value="@Model.Apply.ContactPerson" placeholder="請輸入聯絡人">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><sup title="必填">*</sup> <label for="Apply.Email">Email(登入帳號)</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="email" class="form-element" name="Apply.Email" id="Apply.Email" required disabled value="@Model.Apply.Email" placeholder="請輸入登入帳號">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><sup title="必填">*</sup> <label for="Apply.Birthday">生日(登入密碼)</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="text" class="form-element datepicker" name="Apply.Birthday" id="Apply.Birthday" disabled required value="@Model.Apply.Birthday" placeholder="請輸入登入密碼">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><sup title="必填">*</sup> <label for="Apply.MobilePhone">手機</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="tel" class="form-element" name="Apply.MobilePhone" maxlength="10" id="Apply.MobilePhone" required value="@Model.Apply.MobilePhone" placeholder="請輸入手機">
                        </dd>
                    </dl>
                </section>
                <section class="col-md-6 pr-0">
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><sup title="必填">*</sup> <label for="Apply.CompanyPhone">公司電話</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="tel" class="form-element" name="Apply.CompanyPhone" id="Apply.CompanyPhone" required value="@Model.Apply.CompanyPhone" placeholder="請輸入公司電話">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><label for="Apply.CompanyFax">公司傳真</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="tel" class="form-element" name="Apply.CompanyFax" id="Apply.CompanyFax" value="@Model.Apply.CompanyFax">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><label for="Apply.BusinessNo">統編</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="number" class="form-element" name="Apply.BusinessNo" id="Apply.BusinessNo" value="@Model.Apply.BusinessNo">
                        </dd>
                    </dl>
                    <dl class="field">
                        <dt class="col-sm-2 col-md-4"><label for="Apply.BusinessNoTitle">統編抬頭</label></dt>
                        <dd class="col-sm-10 col-md-8">
                            <input type="text" class="form-element" name="Apply.BusinessNoTitle" id="Apply.BusinessNoTitle" value="@Model.Apply.BusinessNoTitle">
                        </dd>
                    </dl>
                </section>
            </fieldset>

            <fieldset class="clear">
                <legend class="font-lg underline">參加人員 <small>(限 @Model.TrainInfo.SingleEnrollmentRestrictions 人)</small></legend>
                @{
                    int remainder = (Model.TrainInfo.SingleEnrollmentRestrictions - Model.Apply.ParticipantsData.Count);
                    int index = 0;
                }
                @foreach (var participant in Model.Apply.ParticipantsData)
                {
                    index = Model.Apply.ParticipantsData.IndexOf(participant);
                    <dl class="field participantsData">
                        <dt class="col-sm-1">
                            @*@if (index == 0)
                            {
                                <sup title="必填">*</sup>
                            }*@
                            <label for="Apply.ParticipantsData[@index].Name">姓名</label>
                        </dt>
                        <dd class="col-sm-2">
                            <input type="hidden" name="Apply.ParticipantsData[@index].BeforeID" value="@participant.ID" />
                            <input type="text" class="form-element" name="Apply.ParticipantsData[@index].Name" id="Apply.ParticipantsData[@index].Name" value="@participant.Name" placeholder="請輸入姓名">
                        </dd>
                        <dt class="col-sm-1"><label for="Apply.ParticipantsData[@index].JobTitle">職稱</label></dt>
                        <dd class="col-sm-2">
                            <input type="text" class="form-element" name="Apply.ParticipantsData[@index].JobTitle" id="Apply.ParticipantsData[@index].JobTitle" value="@participant.JobTitle" placeholder="請輸入職稱">
                        </dd>

                        <dd class="col-sm-5">

                            @if (participant.DietType == OutWeb.Enums.DietCategory.Meat)
                            {
                                <label>
                                    <input type="radio" class="radio" name="Apply.ParticipantsData[@index].DietTypeValue" checked value="Meat">
                                    <i class="icon"></i>葷
                                </label>
                                <label class="ml-12">
                                    <input type="radio" class="radio" name="Apply.ParticipantsData[@index].DietTypeValue" value="Vegetarian">
                                    <i class="icon"></i>素
                                </label>
                            }
                            else
                            {
                                <label>
                                    <input type="radio" class="radio" name="Apply.ParticipantsData[@index].DietTypeValue" checked value="Meat">
                                    <i class="icon"></i>葷
                                </label>
                                <label class="ml-12">
                                    <input type="radio" class="radio" name="Apply.ParticipantsData[@index].DietTypeValue" checked value="Vegetarian">
                                    <i class="icon"></i>素
                                </label>
                            }

                                @* 清除資料 *@
                                <label class="ml-16">
                                    <input type="checkbox" class="checkbox cancel" name="Apply.ParticipantsData[@index].StatusCodeFromUser">
                                    <i class="icon ti-close"></i> 取消報名(單一)
                                </label>


                            @{
                                string labelStyle = string.Empty;
                                string hidden = string.Empty;
                                switch (participant.StatusCode)
                                {
                                    case 0:
                                        labelStyle = "label-warning";
                                        hidden = "hidden";
                                        break;
                                    case 1:
                                        labelStyle = "label-success";
                                        break;
                                    case 2:
                                        labelStyle = "label-warning";
                                        break;
                                    default:
                                        break;
                                }

                            }
                            <span @hidden class="@labelStyle">@participant.StatusDescription</span>
                        </dd>
                    </dl>
                                }
                @{
                    if (Model.Apply.ParticipantsData.Count > 0)
                    {
                        index++;
                    }
                }
                @for (int i = 0; i < remainder; i++)
                {
                    int rIndex = index + i;
                    <dl class="field participantsData">
                        <dt class="col-sm-1">
                            @if (rIndex == 0)
                            {
                                <sup title="必填">*</sup>
                            }
                            <label for="Apply.ParticipantsData[@rIndex].Name">姓名</label>
                        </dt>
                        <dd class="col-sm-2">
                            <input type="text" class="form-element applyerName" name="Apply.ParticipantsData[@rIndex].Name" id="Apply.ParticipantsData[@rIndex].Name" value="" placeholder="請輸入姓名">
                        </dd>
                        <dt class="col-sm-1"><label for="Apply.ParticipantsData[@rIndex].JobTitle">職稱</label></dt>
                        <dd class="col-sm-2">
                            <input type="text" class="form-element applyerJobTitle" name="Apply.ParticipantsData[@rIndex].JobTitle" id="Apply.ParticipantsData[@rIndex].JobTitle" value="" placeholder="請輸入職稱">
                        </dd>

                        <dd class="col-sm-5">
                            <label>
                                <input type="radio" class="radio" name="Apply.ParticipantsData[@rIndex].DietTypeValue" checked value="Meat">
                                <i class="icon"></i>葷
                            </label>
                            <label class="ml-12">
                                <input type="radio" class="radio" name="Apply.ParticipantsData[@rIndex].DietTypeValue" value="Vegetarian">
                                <i class="icon"></i>素
                            </label>
                            @*<label class="ml-16">
                                    <input type="checkbox" class="checkbox">
                                    <i class="icon ti-close"></i> 取消報名(單一)
                                </label>
                                <span class="label-success">報名成功</span>*@
                        </dd>
                    </dl>
                }

                @*<dd class="col-sm-5">
                        <label>
                            <input type="radio" class="radio" name="rdo">
                            <i class="icon"></i>葷
                        </label>
                        <label class="ml-12">
                            <input type="radio" class="radio" name="rdo">
                            <i class="icon"></i>素
                        </label>

                        <label class="ml-16">
                            <input type="checkbox" class="checkbox">
                            <i class="icon ti-close"></i> 取消報名(單一)
                        </label>
                        <span class="label-success">報名成功</span>
                        <span class="label-warning">報滿候補</span>
                    </dd>*@
            </fieldset>

            <footer class="submit-bar text-center">
                @*  上方的同意有選取時，送出button才可點選
                    不可點選的button如下:
                    <button class="btn lg" disabled>送出</button>
                *@
                <button id="btnSubmit" type="button" class="btn lg">送出</button>
                <button id="cancelBtn" type="button" class="btn muted lg">取消</button>
            </footer>
                    }
        @Html.Raw(alert)

        <div class="table-rwd">

            @{Html.RenderPartial("_ApplyContentPartial", Model.TrainInfo); }
        </div>

        <hr class="mb-12">

        <div class="text-right">
            <button class="ti-printer mr-12" @disableSubmit type="button" onclick="webprint('content')" onkeypress="webprint('content')">友善列印</button>
            <a href="~/User/TrainList" class="ti-layout-grid2-alt">回列表</a>
        </div>
    </div><!-- content //-->
</div><!-- wrap -->
<script>
    $(function () {

        if('@Model.TrainInfo.IsStopRegistering' == 'False')
        {
            $(':input').attr('readonly', 'readonly');
            $(':input[type="button"]').attr('disabled', 'disabled');
        }

        if ('@TempData["Error"]' != '')
        {
            alert('@TempData["Error"]');
        }
        $('#delApply').click(function () {
            if (confirm("是否確定刪除報名?")) {
                deleteApply();
            }
        });

        $('#btnSubmit').click(function () {
            var validSuccess = validHtmlFormRequired();
            if (!validSuccess)
                return;

            var mail = $('input[type="email"]').val();
            if (mail != '') {
                var vailMail = validEmail(mail);
                if (!vailMail) {
                    alert('信箱格式不正確');
                    return;
                }
            }

            var firstPaVal = $('.participantsData').find('input[name*="Apply.ParticipantsData"]').first().val();
            if (firstPaVal == '') {
                alert('至少需要一位參加人員');
                return;
            }
            var validNameJob =true;
            $('.applyerName').each(function (i,e) {
                var nameValue = $(e).val();
                if (nameValue != '')
                {
                    var job = $('.applyerJobTitle').eq(i).val();
                    if (job == '')
                    {
                        validNameJob=false;
                        return false;
                    }
                }
            });

            if (!validNameJob)
            {
                alert('報名者必須請輸入職稱');
                return;
            }

            $('#frmFrontUserTrainApply')[0].submit();
        });

        $('#cancelBtn').click(function () {
            window.location.href = '@Url.Action("List", "Train")';
        });

        $('.cancel').change(function () {
            if ($(this).is(":checked")) {
                $(this).closest('.field').find('input[type="text"]').val('');
            }
        });
    })

    function validEmail(url) {
        var expression = /^(([^<>()\[\]\.,;:\s@@\"]+(\.[^<>()\[\]\.,;:\s@@\"]+)*)|(\".+\"))@@(([^<>()[\]\.,;:\s@@\"]+\.)+[^<>()[\]\.,;:\s@@\"]{2,})$/i;
        var regex = new RegExp(expression);

        if (url.match(regex)) {
            return true;

        } else {
            return false;
        }
    }


    function deleteApply() {
        url = "@Url.Content("~/User/DeleteApply/")";

        $.ajax({
            async: false,
            type: "POST",
            url: url,
            dataType: 'json',
            data: {trainID:'@Model.TrainInfo.ID',applyID:'@Model.Apply.ID'},
            success: function (result) {
                if (result.success == true) {
                    alert('刪除成功');
                    window.location.href = result.url;
                } else {
                    alert('刪除成失敗');
                    return;
                }
            },
            error: function (error) {
                alert('error');
            }
        });
    }




    //驗證Required欄位
    function validHtmlFormRequired() {
        var valid = true;
        var form = document.getElementById('frmFrontUserTrainApply');
        for (var i = 0; i < form.elements.length; i++) {
            if (form.elements[i].value === '' && form.elements[i].hasAttribute('required')) {
                alert(form.elements[i].placeholder);
                valid = false;
                return;
            }
        }
        return valid;
    }
</script>