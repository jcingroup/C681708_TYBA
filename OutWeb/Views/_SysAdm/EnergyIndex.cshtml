@using OutWeb.Models.Manage.EditorModels
@model EnergyIndexModel
@{
    Layout = "~/Views/Shared/_MLayout.cshtml";
    ViewBag.Crumb = "能效指標申報系統頁";
    ViewBag.subnav = "General";
    ViewBag.subnav2 = "EnergyIndex";

    string currentUrl = "http://" + HttpContext.Current.Request.Url.Authority;
    string ActionName = Convert.ToString(HttpContext.Current.Request.RequestContext.RouteData.Values["Action"]);
}

@section Breadcrumb {
    <ul class="breadcrumb">
        <li>一般頁面管理</li>
        <li>@ViewBag.Crumb</li>
    </ul>
}
<h3 class="title">@ViewBag.Crumb <small class="oi" data-glyph="tags">編輯</small></h3>
@using (Html.BeginForm("EnergyIndex", "_SysAdm", FormMethod.Post, new { id = "formEnergyIndex", @class = "form-list" }))
{
    @*<input type="hidden" id="hdnActionName" name="hdnActionName" value="@ActionName" />*@
    <dl class="field">
        <dt class="col-2">附件上傳</dt>
        <dd class="col-8 append-file-m">
            <div class="input-file">
                <input id="files_m" type="file" onchange="postFiles(this);" multiple>
            </div>
            <ul class="file-pre-ul" style="list-style:none;">

                @foreach (var file in Model.FilesData)
                {
                    string imgUrl = currentUrl + "/" + file.FileUrl;
                    int index = Model.FilesData.IndexOf(file);
                    <li class="uploaded">
                        <button type="button" class="btn-del file-remove-btn tooltip" del-obj="f" id="@file.FileName"><i class="tips">刪除此筆檔案</i>&times;</button>
                        <a class="dlFile" href="javascript:;" url="@imgUrl" real-name="@file.RealFileName">@file.RealFileName</a>
                        <input type="hidden" id="imgID" name="FileData[@index].ID" value="@file.ID" />
                    </li>
                }

            </ul>

        </dd>
    </dl>

     <fieldset class="mt-24">
        <legend class="underline">[ 內容 ]</legend>
        <div class="alert-warning mb-16">
            <strong>編輯器注意事項:</strong><br>
            從 WORD 複製文字時，請使用下方的 <img src="/Content/images/icon-word.jpg" /> 圖示來貼上 WORD 文字，避免跑版<br />
            編輯器上傳圖片或新增表格等時，請勿設定寬度及高度(將數字刪除) ，以免行動裝置顯示時會跑版。<br />
            檔案尺寸寬度超過 1600 或 高度超過1200 的圖片會被壓縮(PNG透明背景會變成不透明)
        </div>
        <textarea rows="18" name="contenttext">@Model.Content</textarea>
    </fieldset>

    <footer class="submit-bar clear mt-24">
        <button type="button" id="submitBtn" class="btn success oi" data-glyph="circle-check">
            確認儲存
        </button>
    </footer>
}
<script>
    (function ($) {
        $(function () {
            CKFinder.setupCKEditor(null, { basePath: '/ckfinder/', skin: 'v1' });
            CKEDITOR.replace('contenttext');
        })
    })(jQuery);
</script>

<script>
    $(function () {
        //表單送出
        $('#submitBtn').click(function () {
            SaveImages();
        });
    })


    var fileList = [];
    var fileLimitFileSize = 10485760//檔案大小10mb 單位bit
       var blobBuffer = {};

    //圖片/檔案存server
    function SaveImages() {
        //重置ckeditor content
        for (instance in CKEDITOR.instances) {
            CKEDITOR.instances[instance].updateElement();
        }
        var ID = $('#hdnID').val();
        var formData = document.getElementById('formEnergyIndex');
        formData = new FormData(formData);

        for (var i = 0; i < fileList.length; i++) {
            var data = fileList[i];
            if (data.type == 's') {
                formData.append('image', data.files);
            }
            else if (data.type == 'm') {
                formData.append('images', data.files);
            }
            else if (data.type == 'f') {
                formData.append('files', data.files);
            }
        }

        formData.append("act", 'post');
        formData.append("actionName", '@ActionName');
        formData.append("ID", ID);

        var url = "@Url.Content("~/_SysAdm/EnergyIndex/")";

        $.ajax({
            async: false,
            type: "POST",
            url: url,
            data: formData,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (response) {
                window.location.href = response.Url;
            },
            error: function (error) {
                alert('error');
                window.location.reload();
            }
        });
    }



    //檔案下載
    $(document).on('click', '.dlFile', function () {
        downloadFile(this);
    });

    //檔案刪除
    $(document).on('click', '.file-remove-btn', function () {
        var delIndex = [];
        var id = $(this).attr('id');
        var t = $(this).attr('del-obj');
        for (var i = 0; i < fileList.length; i++) {
            var data = fileList[i];
            if (data.type == t && data.files.name == id) {
                delIndex.push(i);
            }
        }
        for (var i = 0; i < delIndex.length; i++) {
            fileList.splice(delIndex[i], 1);
        }
        $(this).parent('li').remove();
    })

    //檔案預覽
    function postFiles(elem) {
        var f = document.getElementById('files_m');
        //檢查格式尺寸
        var sizePass = checkFileLimitSize(f, fileLimitFileSize);
        if (!sizePass) {
            return;
        }

        for (var i = 0; i < f.files.length; i++) {
            //建立Object URL
            var url = window.URL.createObjectURL(f.files[i]);
            var filename = f.files[i].name;
            var blobObjectFile = f.files[i];
            var ra = '';
            //For IE
            if (window.navigator.msSaveOrOpenBlob) {
                ra = Math.random();
                blobBuffer[ra] = { blobObj: blobObjectFile, fileName: filename };
            }
            var $li = '<li class="uploaded"><button type="button" class="btn-del file-remove-btn tooltip" del-obj="f" id="' + f.files[i].name + '"><i class="tips">刪除此筆檔案</i>&times;</button>' +
                '<a class="dlFile" href="javascript:;" ie-id="' + ra + '"  url="' + url + '" real-name="' + filename + '">' + filename + '</a>' +
                '</li>';

            $('.file-pre-ul').append($li);
            fileList.push({ type: 'f', files: f.files[i] });

            //註銷Object URL
            //window.URL.revokeObjectURL(url);
        }
    }

    function createFileTempUrl(elem) {
        var a = document.createElement('a');
        var url = window.URL.createObjectURL(blob);
        var filename = 'what-you-want.txt';
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }


    function downloadFile(elem) {
        //for IE
        if (window.navigator.msSaveOrOpenBlob) {
            if (Object.keys(blobBuffer).length > 0) {
                var key = $(elem).attr('ie-id');
                var obj = blobBuffer[key];

                var blobObject = new Blob([obj.blobObj]);
                window.navigator.msSaveOrOpenBlob(blobObject, obj.fileName);
            }
        }
        else {
            $(elem).attr('download', $(elem).attr('real-name'))
           .attr('href', $(elem).attr('url'))
           .attr('target', '_blank');
        }
    }
    //檢查尺寸
    function checkFileLimitSize(totalFiles, fileLimitSize) {
        var success = true;
        for (var i = 0; i < totalFiles.files.length; i++) {
            var file = totalFiles.files[i];
            if (file.size > fileLimitSize) {
                success = false;
                alert("圖片或檔案大小不可超過" + (fileLimitSize / 1024) + " kb.");
                break;
            }
        }
        return success;
    }
</script>