@using OutWeb.Models.Manage.ManageTrainApplyModels
@model TrainApplyListViewModel
@{
    Layout = "~/Views/Shared/_MLayout.cshtml";
    ViewBag.Crumb = "報名維護";
    ViewBag.subnav = "Trains";
    ViewBag.subnav2 = "TrainApply";
}
@section IncludeScript{

    <script>
        (function ($) {
            $(function () {
                if('@TempData["TypeError"]' != '')
                {
                    alert('@TempData["TypeError"]');
                    window.location.href = '/_SysAdm/TrainApplyList';
                    return;
                }


                //搜尋
                $('#searchBtn').click(function () {
                    $('#numPage').val(1);
                    $('#formManageTrainApply').submit();
                });

                //分頁input
                $('#numPage').on('keyup mouseup', function () {
                    var minPage = @Model.Result.Pagination.FirstPage;
                    var maxPage = @Model.Result.Pagination.LastPage;
                    var currentPage=$(this).val() ;
                    if(currentPage < minPage)
                    {
                        currentPage = minPage;
                    }

                    if(currentPage > maxPage)
                    {
                        currentPage = maxPage;
                    }
                    $(this).val(currentPage);
                    $('#formManageTrainApply').submit();
                });

                //刪除
                $('.delete-btn').click(function () {
                    var id = $(this).attr('data-id');
                    var url = "@Url.Content("~/_SysAdm/TrainDelete")";
                    $.ajax({
                        async: false,
                        url: url,
                        data: { ID: id },
                        type: 'POST',
                        dataType: 'json',
                        success: function (data) {
                            alert(data.messages);
                            if (data.success) {
                                window.location.reload()
                            }
                        }, error: function (error) {
                            alert(error.messages);
                        }
                    });
                })

                //排序
                $('.th-sort-toggle').on('click', function () {
                    var sortNm = $(this).attr('id');
                    var sortType = $(this).attr('sort-type') == '' ? 'asc' : $(this).attr('sort-type');
                    window.location = '@Url.Content("~/_SysAdm/TrainApplyList")' + "?&sort=" + sortNm + '/' + sortType + '&page=@Model.Result.Pagination.CurrentPage';
                })

                var sortColumn;
                var sortTp;
                if ('@Model.Filter.SortColumn' != '') {
                    sortColumn = '@Model.Filter.SortColumn'.split('/')[0]
                    sortTp = '@Model.Filter.SortColumn'.split('/')[1];
                }

                if (sortTp == 'asc') {
                    sortTp = 'desc';
                }
                else {
                    sortTp = 'asc';
                }

                switch (sortColumn) {
                    case "sortDate":
                        $('#sortDate').addClass(sortTp)
                        $('#sortDate').attr('sort-type', sortTp);
                        break;
                    case "sortStatus":
                        $('#sortStatus').addClass(sortTp)
                        $('#sortStatus').attr('sort-type', sortTp);
                        break;
                    case "sortIndex":
                        $('#sortIndex').addClass(sortTp)
                        $('#sortIndex').attr('sort-type', sortTp);
                        break;

                    default:
                        break;
                }
            });
        })(jQuery);
    </script>
}
@section Breadcrumb {
    <ul class="breadcrumb">
        <li>研討會管理</li>
        <li>@ViewBag.Crumb</li>
    </ul>
}

<h3 class="title">@ViewBag.Crumb</h3>
@using (Html.BeginForm("TrainApplyList", "_SysAdm", FormMethod.Get, new { id = "formManageTrainApply" }))
{
@*<div class="btn-group mb-8">
        <button type="button" class="btn success oi" data-glyph="plus" onclick="location.href='@Url.Content("TrainApplyEdit")'">新增</button>
    </div>*@

<header class="table-head form-inline">
    <label>日期</label>
    <input type="text" class="datepicker" name="bDate" value="@Model.Filter.ActivityBeginDate">~<input type="text" class="datepicker" name="eDate" value="@Model.Filter.ActivityEndDate">

    <input type="text" placeholder="請輸入關鍵字" name="qry" value="@Model.Filter.QueryString">
    <button class="btn">搜尋</button>
</header>

<table class="table-list table-hover table-striped">
    <colgroup>
        <col>
        <col style="width: 13.5%">
        <col>
        <col style="width: 14%">
        <col span="2" style="width: 11%">
    </colgroup>
    <tr>
        @* 點選排序功能 (點一下遞增, 點兩下遞減)
            <button class="th-sort-toggle"></button>
            遞增 asc
            <button class="th-sort-toggle asc"></button>
            遞減 desc
            <button class="th-sort-toggle desc"></button>
        *@

        <th class="item-edit">查看</th>
        <th><button type="button" class="th-sort-toggle">活動日期</button></th>
        <th class="text-left">課程名稱</th>
        <th><button type="button" class="th-sort-toggle">已報名人數/上限</button></th>
        <th><button type="button" class="th-sort-toggle">完成繳費人數</button></th>
        <th>便當(葷/素)</th>
    </tr>

    @foreach (var data in Model.Result.Data)
    {
        string info = string.Format("{0}/{1}", data.AlreadyRegisteredCount.ToString().PadLeft(2, '0'), data.EnrollmentRestrictions.ToString().PadLeft(2, '0'));
        string foodInfo = string.Format("{0}/{1}", data.MeatCount.ToString().PadLeft(2, '0'), data.VegetarianCount.ToString().PadLeft(2, '0'));
        string chargesSatusStr = data.ChargesSatus ? data.PayOffCount.ToString() : "免費";
          <tr>
            <td><button class="hover-primary oi" title="查看" data-glyph="zoom-in" type="button" onclick="location.href='@Url.Content("~/_SysAdm/TrainApplyEdit?trainID=" + data.ID)'"></button></td>
            <td>@string.Format("{0}~{1}", data.ActivityDateBegin.ToString("yyyy\\/MM\\/dd"), data.ActivityDateEnd.ToString("yyyy\\/MM\\/dd"))</td>
            <td class="text-left">@data.ActivityName</td>
            <td>@info</td>
            <td>@chargesSatusStr</td>
            <td>@foodInfo</td>
        </tr>
    }

</table>

<footer class="table-foot">
    @{
        int beginCount = Model.Result.Pagination.CurrentPage > 1 ? ((Model.Result.Pagination.CurrentPage - 1) * Model.Result.Pagination.PageSize) + 1 : 1;
        int lastCount =
            Model.Result.Data.Count >= Model.Result.Pagination.PageSize ?
            ((Model.Result.Pagination.CurrentPage) * Model.Result.Pagination.PageSize) : Model.Result.Pagination.DataCount;
        string disabledPre = Model.Result.Pagination.CurrentPage == 1 ? "disabled" : "";
        string disabledNext = Model.Result.Pagination.CurrentPage == Model.Result.Pagination.LastPage ? "disabled" : "";
        string disabledPageInput = Model.Result.Pagination.LastPage == 1 ? "disabled" : "";
    }
    <small class="pull-right">第 @beginCount - @lastCount 筆，共 @Model.Result.Pagination.DataCount 筆</small>
    <nav class="pager">
        <button @disabledPre class="oi" data-glyph="media-step-backward" title="到最前頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.FirstPage');"></button>
        <button @disabledPre class="oi" data-glyph="chevron-left" title="上一頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.PrePage');"></button>
        <span>第<input @disabledPageInput id="numPage" name="page" class="text-center" type="number" value="@Model.Result.Pagination.CurrentPage">頁，共 @Model.Result.Pagination.LastPage 頁</span>
        <button @disabledNext class="oi" data-glyph="chevron-right" title="下一頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.NextPage');"></button>
        <button @disabledNext class="oi" data-glyph="media-step-forward" title="到最後頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.LastPage')"></button>
    </nav>
</footer> 
        }
<script>
    function paginationSubmit(page)
    {
        $('#numPage').val(page);
        $('form')[0].submit();
    }
</script>