
@{
    Layout = "~/Views/Shared/_MLayout.cshtml";
    ViewBag.Crumb = "通知管理";
    ViewBag.subnav = "Notice";

    Dictionary<int, string> status = new Dictionary<int, string>() {
            {0,"未啟動" },
            {1,"已啟動(立即)" },
            {2,"已啟動(預約)" },
            {3,"已取消" },
        };
}

@section IncludeScript{

    <script>
        (function ($) {
            $(function () {

                $('#typeDropList').val('@Model.Filter.Type');
                $('#statusDropList').val('@Model.Filter.Status');
                $('#dStartDate').val('@Model.Filter.DelieverStartDate');
                $('#dEndDate').val('@Model.Filter.DelieverEndDate');

                //搜尋
                $('#searchBtn').click(function () {
                    $('#numPage').val(1);
                    $('#formNoticeList').submit();
                });

                //分頁input
                $('#numPage').on('keyup mouseup', function () {
                    var minPage = @Model.Result.Pagination.FirstPage;
                    var maxPage = @Model.Result.Pagination.LastPage;
                    var currentPage=$(this).val() ;
                    if(currentPage < minPage)
                    {
                        currentPage = minPage;
                    }

                    if(currentPage > maxPage)
                    {
                        currentPage = maxPage;
                    }
                    $(this).val(currentPage);
                    $('#formNoticeList').submit();
                });

                //排序
                $('.th-sort-toggle').on('click', function () {
                    var sortNm = $(this).attr('id');
                    var sortType = $(this).attr('sort-type') == '' ? 'asc' : $(this).attr('sort-type');
                    window.location = '@Url.Content("~/_SysAdm/NoticeList")' + "?&sort=" + sortNm + '/' + sortType + '&page=@Model.Result.Pagination.CurrentPage';
                })

                var sortColumn;
                var sortTp;
                if ('@Model.Filter.SortColumn' != '') {
                    sortColumn = '@Model.Filter.SortColumn'.split('/')[0]
                    sortTp = '@Model.Filter.SortColumn'.split('/')[1];
                }

                if (sortTp == 'asc') {
                    sortTp = 'desc';
                }
                else {
                    sortTp = 'asc';
                }

                switch (sortColumn) {
                    case "sortType":
                        $('#sortType').addClass(sortTp);
                        $('#sortType').attr('sort-type', sortTp);
                        break;
                    case "sortDelieverDate":
                        $('#sortDelieverDate').addClass(sortTp);
                        $('#sortDelieverDate').attr('sort-type', sortTp);
                        break;
                    case "sortInsertDate":
                        $('#sortInsertDate').addClass(sortTp);
                        $('#sortInsertDate').attr('sort-type', sortTp);
                        break;
                    case "sortStatus":
                        $('#sortStatus').addClass(sortTp);
                        $('#sortStatus').attr('sort-type', sortTp);
                        break;

                    default:
                        break;
                }
            });
        })(jQuery);
    </script>
}



@section Breadcrumb {
    <ul class="breadcrumb">
        <li>@ViewBag.Crumb</li>
    </ul>
}

<h3 class="title">@ViewBag.Crumb</h3>

@using (Html.BeginForm("NoticeList", "_SysAdm", FormMethod.Get, new { id = "formNoticeList" }))
{

    <div class="btn-group mb-8">
        <button type="button" class="btn success oi" data-glyph="plus" onclick="location.href='@Url.Content("~/_SysAdm/NoticeEmailEdit?ID=" + '0')'">E-mail通知</button>
        <button type="button" class="btn success oi" data-glyph="plus" onclick="location.href='@Url.Content("~/_SysAdm/NoticePhoneMsgEdit?ID=" + '0')'">簡訊通知</button>
        <button type="button" class="btn success oi" data-glyph="plus" onclick="location.href='@Url.Content("~/_SysAdm/NoticeFaxEdit?ID=" + '0')'">傳真通知</button>
    </div>

    <header class="table-head form-inline">
        @* @if (TempData["TypeError"] == null)
        {
            <label>分類</label>
            @Html.DropDownList("TypeList", null, new { @id = "typeList", @Name = "type" });
        } *@
        <label>發送時間</label>
        <input type="text" class="datepicker" name="dStartDate" value="@Model.Filter.DelieverStartDate" id="dStartDate">~<input type="text" name="dEndDate" class="datepicker"  id="dEndDate" value="@Model.Filter.DelieverEndDate">

        <label>類型</label>
        <select id="typeDropList" name="type">
            <option value="">全部</option>
            <option value="E-mail">E-mail</option>
            <option value="簡訊">簡訊</option>
            <option value="傳真">傳真</option>
        </select>

        <label>狀態</label>
        <select id="statusDropList" name="status">
            <option value="">全部</option>
            <option value="0">未啟動</option>
            <option value="1">已啟動(立即)</option>
            <option value="2">已啟動(預約)</option>
            <option value="3">已取消</option>
        </select>

        <input type="text" placeholder="請輸入關鍵字" name="qry" value="@Model.Filter.QueryString">
        <button class="btn">搜尋</button>
    </header>

    <table class="table-list table-hover table-striped">
        <colgroup>
            <col span="2">
            <col style="width: 10%">
            <col>
            <col style="width: 20%">
            <col style="width: 20%">
            <col style="width: 12%">
        </colgroup>
        <tr>
            @* 點選排序功能 (點一下遞增, 點兩下遞減)
                <button class="th-sort-toggle"></button>
                遞增 asc
                <button class="th-sort-toggle asc"></button>
                遞減 desc
                <button class="th-sort-toggle desc"></button>
            *@

            <th class="item-edit">刪除</th>
            <th class="item-edit">修改</th>
            <th><button id="sortType" type="button" sort-type="" class="th-sort-toggle">類型</button></th>
            <th class="text-left">標題</th>
            <th><button id="sortInsertDate" type="button" sort-type="" class="th-sort-toggle">通知建立時間</button></th>
            <th><button id="sortDelieverDate" type="button" sort-type="" class="th-sort-toggle">通知發送時間</button></th>
            <th><button id="sortStatus" type="button" sort-type="" class="th-sort-toggle">狀態</button></th>

        </tr>

        @if (Model.Result.Data.Count == 0)
        {
            <tr class="bg-pale-red"><td colspan="7">查無資料!</td></tr>
        }
        @foreach (var data in Model.Result.Data)
        {
            <tr>
                <td><button class="hover-danger oi delete-btn" title="刪除" type="button" data-glyph="trash" data-id="@data.NO" onclick="deleteItem('@data.STYPE','@data.ID','@data.TITLE')"></button></td>
                @if (data.STYPE == "E-mail")
                {

                    <td><button class="hover-primary oi" title="修改" data-glyph="pencil" type="button" onclick="location.href='@Url.Content("~/_SysAdm/NoticeEmailEdit?ID=" + data.ID)'"></button></td>
                }
                else if (data.STYPE == "簡訊")
                {
                    <td><button class="hover-primary oi" title="修改" data-glyph="pencil" type="button" onclick="location.href='@Url.Content("~/_SysAdm/NoticePhoneMsgEdit?ID=" + data.ID)'"></button></td>
                }
                else
                {
                    <td><button class="hover-primary oi" title="修改" data-glyph="pencil" type="button" onclick="location.href='@Url.Content("~/_SysAdm/NoticeFaxEdit?ID=" + data.ID)'"></button></td>
                }
                <td>@data.STYPE</td>
                <td class="text-left">@data.TITLE</td>
                <td>@data.INSERT_DATE</td>
                <td>@data.DELIEVER_DATE</td>

                @if (data.STATUS == 0)
                {
                    <td><span class="label">@status[data.STATUS]</span></td>
                }
                else if (data.STATUS == 1 || data.STATUS == 2)
                {
                    <td><span class="label-success">@status[data.STATUS]</span></td>
                }
                else
                {
                    <td><span class="label-danger">@status[data.STATUS]</span></td>
                }
            </tr>
        }
    </table>


    <script>
        function deleteItem(type, id,title) {
            if (!confirm("是否確定要刪除此" + type + "\n" + "標題為:" + title)){
                return false;
            }
             if (type == "傳真") {
                    url = "@Url.Content("~/_SysAdm/NoticeFaxDelete")";
             }
            else if(type == "E-mail") {
                url = "@Url.Content("~/_SysAdm/NoticeEmailDelete")";
             } else {
                url = "@Url.Content("~/_SysAdm/NoticePhoneDelete")";
             }

            $.ajax({
                async: false,
                type: "POST",
                url: url,
                url: url,
                data: JSON.stringify({ 'ID': id }),
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    if (response.success == true) {
                        alert("刪除成功");
                    } else {
                        alert(response.messages);
                    }
                    window.location.reload();
                },
                error: function (error) {
                    alert('ajax error');
                    window.location.reload();
                }
            });
        };
</script>


     <footer class="table-foot">
         @{
             int beginCount = Model.Result.Pagination.CurrentPage > 1 ? ((Model.Result.Pagination.CurrentPage - 1) * Model.Result.Pagination.PageSize) + 1 : 1;
             int lastCount =
                 Model.Result.Data.Count >= Model.Result.Pagination.PageSize ?
                 ((Model.Result.Pagination.CurrentPage) * Model.Result.Pagination.PageSize) : Model.Result.Pagination.DataCount;
             string disabledPre = Model.Result.Pagination.CurrentPage == 1 ? "disabled" : "";
             string disabledNext = Model.Result.Pagination.CurrentPage == Model.Result.Pagination.LastPage ? "disabled" : "";
             string disabledPageInput = Model.Result.Pagination.LastPage == 1 ? "disabled" : "";
         }
         <small class="pull-right">第 @beginCount - @lastCount 筆，共 @Model.Result.Pagination.DataCount 筆</small>
         <nav class="pager">
             <button @disabledPre class="oi" data-glyph="media-step-backward" title="到最前頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.FirstPage');"></button>
             <button @disabledPre class="oi" data-glyph="chevron-left" title="上一頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.PrePage');"></button>
             <span>第<input @disabledPageInput id="numPage" name="page" class="text-center" type="number" value="@Model.Result.Pagination.CurrentPage">頁，共 @Model.Result.Pagination.LastPage 頁</span>
             <button @disabledNext class="oi" data-glyph="chevron-right" title="下一頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.NextPage');"></button>
             <button @disabledNext class="oi" data-glyph="media-step-forward" title="到最後頁" type="button" onclick="paginationSubmit('@Model.Result.Pagination.LastPage')"></button>
         </nav>
    </footer>
}

<script>
    function paginationSubmit(page)
    {
        $('#numPage').val(page);
        $('form')[0].submit();
    }
</script>